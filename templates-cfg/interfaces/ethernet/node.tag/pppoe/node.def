#
# Configuration template for interface/ethernet/node.tag/pppoe
#
#
# Define a PPPOE interface.  The value of this node is the PPPOE unit
# number.  This number must be unique within the interface that it is
# subordinate to, but need not be globally unique.  I.e. there can be a PPPOE
# unit 3 under both eth1 and eth2.
#
#

tag:

type: u32

help: PPPOE unit number.

syntax:expression:  ((($VAR(@) >= 0) && ($VAR(@) <= 15)) ; \
        "Only unit number must be between 0 and 15") && \
        ( exec "NOT_OURS=`grep -s ^pty /etc/ppp/peers/pppoe$VAR(@) | grep -v -c $VAR(../@)` ; \
                if [ $NOT_OURS -eq 0 ]; then \
                        exit 0 ; \
                else \
                        exit 1 ; \
                fi " ; \
        "Unit number must be unique. Units already in use are: $VAR(../@@/pppoe/@@)" )



#
# Update script will only be called when a new node is created, so this
# is essentially a create operation.  We initialize a new PPP provider
# configuration file from our template.  Other parameters will be inserted
#
update:	sudo rm -f /etc/ppp/peers/pppoe$VAR(@)
	sudo cp /opt/vyatta/etc/pppoe-provider-template \
	   /etc/ppp/peers/pppoe$VAR(@) 
	sudo sh -c "echo pty \\\"/usr/sbin/pppoe -m 1412 -I $VAR(../@)\\\" >> \
	     /etc/ppp/peers/pppoe$VAR(@)"
	sudo sh -c "echo persist >> /etc/ppp/peers/pppoe$VAR(@)"
	sudo sh -c "echo mtu 1492  >> /etc/ppp/peers/pppoe$VAR(@)"
	sudo sh -c "echo mru 1492  >> /etc/ppp/peers/pppoe$VAR(@)"
        sudo sh -c "echo defaultroute  >> /etc/ppp/peers/pppoe$VAR(@)"
	sudo sh -c "echo usepeerdns  >> /etc/ppp/peers/pppoe$VAR(@)"
	sudo sh -c "echo ipparam pppoe$VAR(@) >> /etc/ppp/peers/pppoe$VAR(@)"

#
# Delete means that this node and the tree below it has been deleted.
# We can delete the PPP provider configuration file.  The running PPPOE
# Daemon will be killed at "end:"
# 
delete:	sudo rm -f /etc/ppp/peers/pppoe$VAR(@)

#
# Three cases are handled here:
#  1) A new PPPOE configuration node has just been added.  Parameters may or
#     may not have also been added.
#  2) Some configuration parameters of a previously existing PPPOE node
#     have been changed.
#  3) A previously existing PPPOE configuration node has been deleted.
# 
# In case (1) we need to start the daemon for the first time.
# In case (2) we need to kill and restart the daemon.
# In case (3) we need to kill the daemon.
#
end:	sudo poff pppoe$VAR(@) | logger -p debug -t pppoe$VAR(@)-template
	if [ -e /etc/ppp/peers/pppoe$VAR(@) ]; then
                ( umask 0; sudo /usr/sbin/pppd call pppoe$VAR(@) > \
		  	/tmp/pppoe$VAR(@).log 2>&1 & )
	fi
